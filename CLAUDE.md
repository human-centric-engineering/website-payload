# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Payload CMS website template built with Next.js 15, React 19, and PostgreSQL. It provides a full-featured headless CMS with an admin panel and a production-ready frontend, all served from a single Next.js application using the App Router.

## Substrate Documentation

**Comprehensive technical documentation is available in `.context/`** for AI-assisted development.

**Start here:** `.context/substrate.md` - Entry point with navigation to all domains

**Documentation domains:**
- **Architecture** - System design, request flows, dependency injection patterns
- **Authentication** - JWT auth, security model, integration patterns
- **API** - Complete REST/GraphQL reference with client examples
- **Database** - PostgreSQL schema, TypeScript models, migration workflow
- **Guidelines** - Development workflow, testing strategies, deployment

**When to use:**
- Implementing new features (review relevant architecture patterns)
- Debugging issues (check flow diagrams and error handling patterns)
- Understanding data models (see database schema and relationships)
- API integration (reference endpoints and client examples)
- Security concerns (review threat model and mitigations)

This CLAUDE.md provides quick reference; `.context/` provides deep technical context.

## Development Commands

### Core Development
- `pnpm dev` - Start development server on http://localhost:3000
- `pnpm build` - Build for production (includes Next.js build + sitemap generation)
- `pnpm start` - Start production server
- `pnpm dev:prod` - Clean build and start in production mode

### Code Quality
- `pnpm lint` - Run ESLint
- `pnpm lint:fix` - Fix ESLint errors automatically

### Testing
- `pnpm test` - Run all tests (integration + e2e)
- `pnpm test:int` - Run integration tests with Vitest
- `pnpm test:e2e` - Run e2e tests with Playwright
- Integration tests: Located in `tests/int/**/*.int.spec.ts`, run with Vitest + jsdom
- E2E tests: Located in `tests/e2e/`, run with Playwright (auto-starts dev server)

### Payload CMS Commands
- `pnpm payload` - Access Payload CLI
- `pnpm generate:types` - Generate TypeScript types from Payload schema to `src/payload-types.ts`
- `pnpm generate:importmap` - Generate import map for admin panel components

### Database (PostgreSQL)
- `pnpm payload migrate:create` - Create a new migration file
- `pnpm payload migrate` - Run pending migrations (required before production start)
- Local dev uses `push: true` by default - schema changes apply automatically without migrations
- Production requires explicit migrations to avoid data loss

## Architecture

### Monolithic Next.js App Router Structure

The application uses Next.js route groups to separate concerns:

- **`src/app/(payload)/`** - Payload admin panel routes
  - `admin/` - Admin UI (generated by Payload)
  - `api/` - API routes for Payload operations
  - Custom admin styling via `custom.scss`

- **`src/app/(frontend)/`** - Public website routes
  - `[slug]/` - Dynamic pages
  - `posts/` - Blog listing and individual posts
  - `search/` - Search functionality
  - `next/` - Next.js utilities (draft preview, revalidation)

### Payload CMS Configuration

**Main config:** `src/payload.config.ts`

**Collections** (`src/collections/`):
- `Pages` - Layout builder pages with draft/publish workflow
- `Posts` - Blog posts with categories and layout builder
- `Media` - File uploads with image transformations (Sharp)
- `Categories` - Nested taxonomy for posts
- `Users` - Authentication-enabled admin users

**Globals** (`src/Header/config.ts`, `src/Footer/config.ts`):
- Header - Navigation data
- Footer - Footer content

**Key Features:**
- **Layout Builder:** Page/Post content uses block-based layouts (see `src/blocks/`)
- **Draft Preview:** Pages and Posts support draft versions with live/static preview
- **Scheduled Publishing:** Jobs queue handles scheduled publish/unpublish
- **Lexical Editor:** Rich text editing configured in `src/fields/defaultLexical.ts`

### Layout Builder Blocks

Located in `src/blocks/`:
- `ArchiveBlock` - Display collections of posts
- `Banner` - Alert/notification banners
- `CallToAction` - CTA sections
- `Code` - Code snippets with syntax highlighting
- `Content` - Rich text content
- `Form` - Form builder integration
- `MediaBlock` - Images/videos
- `RelatedPosts` - Related content suggestions

Blocks are registered per-collection in Pages/Posts configs and rendered via `RenderBlocks.tsx`.

### Access Control

Basic access control patterns in `src/access/`:
- `authenticated.ts` - Requires logged-in user
- `authenticatedOrPublished.ts` - Public can read published, users can read drafts

Applied to collections to control create/read/update/delete permissions.

### Hooks System

**Collection Hooks** (e.g., `src/collections/Pages/hooks/`):
- `revalidatePage.ts` - Triggers Next.js revalidation after publish
- `populatePublishedAt.ts` - Auto-set publish dates

**Global Hooks:**
- `revalidateRedirects.ts` - Updates redirects cache

Hooks run on `beforeChange`, `afterChange`, `afterDelete` lifecycle events.

### Plugins

Configured in `src/plugins/index.ts`:
- `@payloadcms/plugin-seo` - SEO fields and meta generation
- `@payloadcms/plugin-search` - Full-text search on posts
- `@payloadcms/plugin-redirects` - URL redirect management
- `@payloadcms/plugin-nested-docs` - Hierarchical categories
- `@payloadcms/plugin-form-builder` - Dynamic forms

### Frontend Components

**Hero Blocks** (`src/heros/`): Different hero layouts for pages
**UI Components** (`src/components/`): Shared frontend components
**Styling:** TailwindCSS with custom config in `tailwind.config.mjs`

### Utilities

Located in `src/utilities/`:
- `getDocument.ts` - Fetch Payload documents
- `getGlobals.ts` - Fetch global data
- `generatePreviewPath.ts` - Build preview URLs
- `generateMeta.ts` - SEO metadata generation
- `getURL.ts` - Server-side URL helpers
- Frontend utilities for date formatting, deep merging, etc.

### Type Safety

- Generated types: `src/payload-types.ts` (auto-generated from Payload schema)
- TypeScript paths configured with `@/*` alias pointing to `src/*`
- Always regenerate types after schema changes: `pnpm generate:types`

### Environment Variables

Required vars (see `.env.example`):
- `DATABASE_URI` - PostgreSQL connection string
- `PAYLOAD_SECRET` - JWT encryption key
- `NEXT_PUBLIC_SERVER_URL` - Public URL for CORS and link generation
- `CRON_SECRET` - Authenticates scheduled job requests
- `PREVIEW_SECRET` - Validates draft preview requests

### Revalidation Strategy

Next.js caching is **disabled by default** (for Payload Cloud compatibility). To enable:
1. Remove `no-store` from fetch calls in `src/app/_api`
2. Remove `export const dynamic = 'force-dynamic'` from page components
3. On-demand revalidation triggers via hooks when content is published

### Database Migrations

**Local Development:**
- Default `push: true` - schema changes apply automatically
- Safe for rapid iteration, no manual migrations needed

**Production:**
1. Set `push: false` in `payload.config.ts`
2. Create migration: `pnpm payload migrate:create`
3. Commit migration files
4. Deploy and run: `pnpm payload migrate` before `pnpm start`

### Docker Support

- `docker-compose.yml` - Orchestrates app and database
- `Dockerfile` - Multi-stage build for production
- Run: `docker-compose up`

## Important Notes

- **Import map:** Regenerate after adding admin components: `pnpm generate:importmap`
- **Seeding:** Admin panel has "seed database" link (destructive - drops existing data)
- **Node version:** Requires Node ^18.20.2 or >=20.9.0
- **Package manager:** Use pnpm (version ^9 or ^10)
- **Image processing:** Uses Sharp for resize/transforms
- **Jobs queue:** Handles scheduled publishing via cron (may be limited on Vercel)
